# ============================================================
# GITHUB ACTIONS - Continuous Integration (CI) Pipeline
# ============================================================
#
# Was macht diese Datei?
# Diese GitHub Actions Workflow-Datei automatisiert die QualitÃ¤tsprÃ¼fung
# bei jedem Push und Pull Request. Sie fÃ¼hrt aus:
# 1. Linting (ESLint) - Code-QualitÃ¤tsprÃ¼fung
# 2. Formatting (Prettier) - FormatierungsprÃ¼fung
# 3. Tests (Vitest) - Automatisierte Tests
# 4. Build - TypeScript-Kompilierung
# 5. Security Audit - OWASP Dependency Check
#
# Warum CI/CD?
# - Fehler werden frÃ¼h erkannt (automatisch bei jedem Push)
# - Einheitliche Code-QualitÃ¤t im Team
# - Verhindert das Mergen von fehlerhaftem Code
# - Dokumentiert den Build-Status (grÃ¼nes Badge = alles okay)
#
# Referenz: https://docs.github.com/en/actions
# ============================================================

name: CI Pipeline

# Wann soll die Pipeline laufen?
on:
  push:
    branches: [main, develop]  # Bei Push auf main oder develop
  pull_request:
    branches: [main]           # Bei PRs gegen main

# Umgebungsvariablen fÃ¼r alle Jobs
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ============================================================
  # JOB 1: Lint & Format Check
  # ============================================================
  lint:
    name: ğŸ” Lint & Format
    runs-on: ubuntu-latest
    
    steps:
      # Schritt 1: Code auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Schritt 2: pnpm installieren (schneller als npm)
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # Schritt 3: Node.js einrichten mit Cache
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # Schritt 4: Dependencies installieren
      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      # Schritt 5: ESLint ausfÃ¼hren
      - name: ğŸ” Run ESLint
        run: pnpm lint

      # Schritt 6: Prettier Check
      - name: ğŸ’… Check Formatting
        run: pnpm format:check

  # ============================================================
  # JOB 2: Tests ausfÃ¼hren
  # ============================================================
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: lint  # Wartet auf erfolgreichen Lint-Job
    
    # PostgreSQL als Service-Container fÃ¼r Integrationstests
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: p
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        # Health-Check damit wir wissen wann DB bereit ist
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      # Prisma Client generieren (fÃ¼r DB-Zugriff)
      - name: ğŸ”· Generate Prisma Client
        run: pnpm prisma:generate
        
      # Prisma Migration ausfÃ¼hren
      - name: ğŸ—„ï¸ Run Database Migrations
        run: pnpm prisma:migrate
        env:
          DATABASE_URL: postgresql://postgres:p@localhost:5432/postgres?schema=film

      # Tests mit Coverage ausfÃ¼hren
      - name: ğŸ§ª Run Tests
        run: pnpm test:cov
        env:
          DATABASE_URL: postgresql://postgres:p@localhost:5432/postgres?schema=film
          NODE_ENV: test

  # ============================================================
  # JOB 3: Build prÃ¼fen
  # ============================================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: test  # Wartet auf erfolgreiche Tests
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”· Generate Prisma Client
        run: pnpm prisma:generate

      # TypeScript kompilieren
      - name: ğŸ—ï¸ Build Application
        run: pnpm build

  # ============================================================
  # JOB 4: Security Audit (OWASP Dependency Check)
  # ============================================================
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      # npm audit fÃ¼r bekannte SicherheitslÃ¼cken
      # --audit-level=high: Nur high/critical Vulnerabilities melden
      - name: ğŸ”’ Security Audit
        run: pnpm audit --audit-level=high
        continue-on-error: true  # Pipeline nicht blockieren, nur warnen
